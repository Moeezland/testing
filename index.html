<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Moeezland e-Civilian Portal</title>

  <style>
    body{
      font-family:"Segoe UI",system-ui,sans-serif;
      background:#edf2f7;
      min-height:100vh;
      margin:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .container{
      background:#fff;
      border-radius:14px;
      box-shadow:0 8px 30px rgba(0,0,0,.08);
      padding:32px 38px;
      width:380px;
      max-width:92%;
    }
    h1{ text-align:center; color:#002e63; }
    label{ font-size:14px; font-weight:500; margin-top:10px; display:block; }
    input{ width:100%; padding:11px; border-radius:8px; border:1px solid #ccc; margin-top:4px; }
    button{
      width:100%; margin-top:14px; padding:11px;
      border:none; border-radius:8px;
      background:#002e63; color:white; font-weight:600;
      cursor:pointer;
    }
    button.secondary{
      background:#e2e8f0;
      color:#002e63;
    }
    .forgot-center{ text-align:center; margin-top:10px; color:#002e63; cursor:pointer; }
    .switch{ margin-top:16px; text-align:center; }
    .switch span{ color:#002e63; font-weight:600; cursor:pointer; }
    #message{ margin-top:12px; color:#b00020; text-align:center; min-height:20px; }
    #capsWarn{ font-size:13px; color:#d97706; display:none; }
  </style>
</head>
<body>

<div class="container">
  <h1>Moeezland e-Civilian Portal</h1>

  <!-- LOGIN -->
  <div id="loginSection">
    <label>Username</label>
    <input id="loginUsername">

    <label>Password</label>
    <input type="password" id="loginPassword">
    <div id="capsWarn">⚠ Caps Lock is ON</div>

    <button id="loginBtn">Login</button>
    <div class="forgot-center" id="forgotBtn">Forgot password?</div>
    <div class="switch">Don’t have an account? <span id="toRegister">Register</span></div>
  </div>

  <!-- FORGOT PASSWORD -->
  <div id="forgotSection" style="display:none;">
    <label>Enter your email</label>
    <input type="email" id="resetEmail">
    <button id="resetBtn">Send reset email</button>
    <button class="secondary" id="backToLogin">Back to login</button>
  </div>

  <!-- REGISTER -->
  <div id="registerSection" style="display:none;">
    <label>Full Legal Name</label>
    <input id="regLegalName">

    <label>Username</label>
    <input id="regUsername">

    <label>Email</label>
    <input type="email" id="regEmail">

    <label>Password</label>
    <input type="password" id="regPassword">

    <label>Civil ID (required)</label>
    <input id="civilId" placeholder="10-digit Civil ID">

    <button id="registerBtn">Create Account</button>
    <div class="switch">Already have an account? <span id="toLogin">Login</span></div>
  </div>

  <div id="message"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getFirestore, doc, collection, query, where, getDocs, runTransaction, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyCs-pheSxe9bkAqnhG9qOjF7RvFfb9k00A",
  authDomain: "e-civilian-portal2007.firebaseapp.com",
  projectId: "e-civilian-portal2007"
});

const auth = getAuth(app);
const db = getFirestore(app);

loginPassword.addEventListener("keyup", e=>{
  capsWarn.style.display = e.getModifierState("CapsLock") ? "block" : "none";
});

loginBtn.onclick = async ()=>{
  message.textContent="";
  try{
    const u = loginUsername.value.trim().toLowerCase();
    const p = loginPassword.value.trim();
    const q = query(collection(db,"users"), where("username_lower","==",u));
    const snap = await getDocs(q);
    if(snap.empty) throw "User not found.";
    await signInWithEmailAndPassword(auth,snap.docs[0].data().email,p);
    window.location.href="dashboard.html";
  }catch(e){
    message.textContent = e==="User not found." ? e : "Incorrect password.";
  }
};

registerBtn.onclick = async ()=>{
  message.textContent="";

  const legalName = regLegalName.value.trim();
  const username = regUsername.value.trim();
  const email = regEmail.value.trim().toLowerCase();
  const password = regPassword.value.trim();
  const civil = civilId.value.replace(/\D/g,"");

  if(!legalName || !username || !email || !password || !civil){
    message.textContent="All fields are required.";
    return;
  }

  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
    message.textContent="Invalid email address.";
    return;
  }

  if(civil.length !== 10){
    message.textContent="Civil ID must be exactly 10 digits.";
    return;
  }

  try{
    if(!(await getDocs(query(collection(db,"users"),
      where("username_lower","==",username.toLowerCase())))).empty)
      throw "Username already taken.";

    if(!(await getDocs(query(collection(db,"users"),
      where("email_lower","==",email)))).empty)
      throw "Email already registered.";

    const cRef = doc(db,"civil_ids",civil);
    const cSnap = await getDoc(cRef);
    if(!cSnap.exists()) throw "Invalid Civil ID.";
    if(cSnap.data().used) throw "Civil ID already used.";

    const cred = await createUserWithEmailAndPassword(auth,email,password);
    const uid = cred.user.uid;

    await runTransaction(db, async tx=>{
      tx.set(doc(db,"users",uid),{
        legalName,
        username,
        username_lower:username.toLowerCase(),
        email,
        email_lower:email,
        civilId:civil,
        createdAt:new Date().toISOString()
      });
      tx.update(cRef,{used:true,userUID:uid});
    });

    window.location.href="dashboard.html";
  }catch(e){
    if(typeof e==="string") message.textContent=e;
    else if(e.code) message.textContent=e.code.replace("auth/","").replace(/-/g," ");
    else message.textContent="Registration failed.";
  }
};

/* FORGOT PASSWORD */
forgotBtn.onclick = ()=>{
  loginSection.style.display="none";
  registerSection.style.display="none";
  forgotSection.style.display="block";
  message.textContent="";
};

backToLogin.onclick = ()=>{
  forgotSection.style.display="none";
  loginSection.style.display="block";
};

resetBtn.onclick = async ()=>{
  message.textContent="";
  const email = resetEmail.value.trim().toLowerCase();
  if(!email){
    message.textContent="Enter your email address.";
    return;
  }
  try{
    await sendPasswordResetEmail(auth,email);
    message.style.color="#166534";
    message.textContent="Password reset email sent.";
  }catch(e){
    message.style.color="#b00020";
    message.textContent = e.code ? e.code.replace("auth/","").replace(/-/g," ") : "Failed to send reset email.";
  }
};

toRegister.onclick = ()=>{ loginSection.style.display="none"; registerSection.style.display="block"; };
toLogin.onclick = ()=>{ registerSection.style.display="none"; loginSection.style.display="block"; };
</script>

</body>
</html>
